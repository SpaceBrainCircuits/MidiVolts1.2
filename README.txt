***CODE/ SCHEMATICS MAY NOT BE USED FOR COMMERCIAL USE***

ARDUINO SKETCH ONLY TO BE USED IN CONJUNCTION WITH MIDIVOLTS SHIELD VERSION 1.1 - 1.2
MIDIVOLTS SKETCH RUNS ON MIDI CHANNEL 1.
ARDUINO TO BE USED WITH 9-12V POWER SUPPLY FOR ACCURATE PITCH CV. UNEXPECTED RESULTS ARE PROBABLE IF POWERED BY USB.

RX MUST BE DISCONNECTED WHEN UPLOADING. THEREFORE, SHIELD MUST BE OFF ARDUINO UNO WHEN UPLOADING SKETCH.

OPTIONAL: CUT TRACE AND ADD TOGGLE TO ALLOW UPLOADING WITH SHIELD ON ARDUINO. 

CONNECT MIDI OUT OF MIDI CONTROLLER TO PINS 4 AND 5 OF MIDI IN SECTION (SEE MIDI JACK PINOUT). LEDS WILL INDICATE WHEN NOTES ARE PRESSED AND WITHIN RANGE OF MIDI # 36-96 (BY DEFAULT). IF THIS IS NOT WORKING, PLEASE VERIFY THE PINOUT OF MIDI IN CONNECTION.

*** MODE SELECTION ***

THE MODE NUMEBR MAY BE ADJUSTED TO 7 DIFFERENT MODES AS EXPLAINED BELOW.

PLEASE CHOOSE MODE
1 VOICE MONOPHONIC ON V0 WITH VELOCITY ON V1, AFTERTOUCH ON V2, AND CC1 (MOD WHEEL) ON V3: ......1
2 VOICE DUOPHONIC ON V0, V1 WITH VELOCITY ON V2 AND V3 RESPECTIVELY: ............................2
3 VOICE POLYPHONIC ON V0, V1, V2 WITH CC1 (MOD WHEEL) ON V3: ....................................3
4 VOICE POLYPHONIC ON V0, V1, V2, V3: ...........................................................4
4 VOICE UNISON ON V0, V1, V2, V3: ...............................................................5
1 VOICE MONOPHONIC ON V0 WITH CC2 ON V1, CC3 ON V2, CC4 ON V3: ..................................6
CC CONTROLLER WITH CC1 ON V0, CC2 ON V1, CC3 ON V2, CC4 ON V3: ..................................7

EXAMPLE CODE:
	#define MODE 1

MIDI RANGE MAY BE CHANGED BY ADJUSTING THE FOLLOWING FIELD IN THE MIDIVOLTS.H FILE.

GO TO MIDIVOLTS.H AND CHANGE THIS VALUE

    const int _lowestMIDINote = 36; // adjusts MIDI range

*** FOR FINE TUNE CALIBRATION WITH MIDIVOLTSCALIBRATION***

SEE CALIBRATION GUIDE

*** FOR FINE TUNE CALIBRATION WITH MULTIMETER***

EXPECTED VOLTAGE ACROSS OCTAVE ARE AS FOLLOW

MIDI #	VOLTAGE
36	0.000
37	0.083
38	0.167
39	0.250
40	0.333
41	0.417
42	0.500
43	0.583
44	0.667
45	0.750
46	0.833
47	0.917
48	1.000

REPEATS THE SAME FOR THE NEXT OCTAVE

49	1.083
50	1.167
51	1.250
...	...
...	...

NOT ALL DACS ARE THE SAME. ACCORDING TO THE MCP4728 DATASHEET, THIS HAS TO DO WITH INCONSISTENCIES IN THE INTERNAL OPAMP. NEAR PERFECT SCALING MAY BE ACHIEVED BY ADJUSTING SOME OF THE PARAMETERS IN CODE INCLUDING OFFSET AND GAIN. THESE ARE TO BE ADJUSTED UNTIL YOU HAVE CLOSE VOLTAGE MEASUREMENTS TO THE ONES SHOWN IN THE TABLE ABOVE ACROSS 5 OCTAVES. (0-5V)

THE FOLLOWING CODE SHOULD BE PLACED IN THE SETUP METHOD.

STEP 1: GAIN ERROR
THE FOLLOWING SHOULD BE PERFORMED ON EACH VOICE (0,1,2).

MEASURE VOLTAGE AT V0 WHEN PRESSING THE FOLLOWING MIDI NOTES.

**********

IDEAL SITUATION

EXAMPLE CODE:
	voice[0].Gain = 1;

MIDI #	VOLTAGE
36	0
48	1
60	2
72	3
84	4
96	5

**********

ADJUST GAIN VALUE IF VOLTAGE IS CREEPING UP OR DOWN. USE TRIAL AND ERROR.
EXAMPLE:
MIDI #	VOLTAGE
36	0
48	1.01
60	2.02
72	3.03
84	4.04
96	5.05

USE THE FOLLOWING CODE TO COMPENSATE FOR INCORRECT SCALING. ADJUST VALUE AS NEEDED.

EXAMPLE CODE:
	voice[0].Gain = 0.996;

**********

STEP 2: OFFSET ERROR

ADJUST OFFSET VALUE IF VOLTAGE IS OFF BY THE SAME AMOUNT ACROSS ALL OCTAVES. USE TRIAL AND ERROR.
EXAMPLE:
MIDI #	VOLTAGE
36	0.05
48	1.05
60	2.05
72	3.05
84	4.05
96	5.05

USE THE FOLLOWING CODE TO COMPENSATE FOR INCORRECT SCALING. ADJUST VALUE AS NEEDED.

EXAMPLE CODE:
	voice[0].Offset = -0.05;

*********************************************

REFERENCES USED FOR DEVELOPING CODE AND CIRCUIT:

INDIANA UNIVERSITY MIDI DOCUMENTATION
MCP4728 DATASHEET
